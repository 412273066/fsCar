<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>申请会员</title>
		<!--标准mui.css-->
		<link href="content/css/mui.min.css" rel="stylesheet" />
		<!--App自定义的css-->
		<link rel="stylesheet" href="content/css/app.css" />
		<link rel="stylesheet" type="text/css" href="content/css/mui.picker.min.css" />
		<style>

		</style>
	</head>

	<body>
		<div class="f-w-h-100 ">
			<div class="m-reg-title">
				<img src="content/images/package.png" /> 套餐选择
			</div>
			<div class="m-reg-radio">
				<form class="mui-input-group">
					<div class="mui-input-row mui-radio mui-left">
						<label class="radio-label" for="tc1">套餐1<p><a href="#popover" tc-desc="套餐1包含免费洗车1年，免费维修1年，免费打气3个月，免费送水1个月">396元<img src="content/images/arrow.png"/></a></p></label>
						<input id="tc1" name="tc" type="radio" value="1" fee="396" vip="VIP1" checked>
					</div>
					<div class="f-horizontal-line"></div>
					<div class="mui-input-row mui-radio mui-left">
						<label class="radio-label" for="tc2">套餐2<p><a href="#popover" tc-desc="套餐2包含免费洗车2年，免费维修2年，免费打气6个月，免费送水1个月">700元<img src="content/images/arrow.png"/></a></p></label>
						<input id="tc2" name="tc" type="radio" value="2" fee="700" vip="VIP2" >
					</div>
					<div class="f-horizontal-line"></div>
					<div class="mui-input-row mui-radio mui-left">
						<label class="radio-label" for="tc3">套餐3<p><a href="#popover" tc-desc="套餐3包含免费洗车3年，免费维修3年，免费打气9个月，免费送水2个月">1400元<img src="content/images/arrow.png"/></a></p></label>
						<input id="tc3" name="tc" type="radio" value="3" fee="1400" vip="VIP3" >
					</div>
					<div class="f-horizontal-line"></div>
					<div class="mui-input-row mui-radio mui-left">
						<label class="radio-label" for="tc4">套餐4<p><a href="#popover" tc-desc="套餐4包含免费洗车5年，免费维修5年，免费打气5个月，免费送水7个月">450元<img src="content/images/arrow.png"/></a></p></label>
						<input id="tc4" name="tc" type="radio" value="4" fee="450" vip="VIP4" >
					</div>
				</form>
			</div>
			<div class="m-reg-title">
				<img src="content/images/user-info-tit.png" /> 会员信息
			</div>
			<div class="m-reg">
				<div class="clearfix">
					<label class="reg-label">会员名称</label>
					<input id="username" class="reg-input" type="text" placeholder="请输入会员名称" />
				</div>
				<div class="f-horizontal-line"></div>
				<div class="clearfix">
					<label class="reg-label">手机号码</label>
					<input id="telephone" class="reg-input" type="text" placeholder="请输入手机号码" />
				</div>
				<div class="f-horizontal-line"></div>
				<div class="clearfix">
					<label class="reg-label">驾驶证号码</label>
					<input id="licenseNo" class="reg-input" type="text" placeholder="请输入驾驶证号码" style="width: 50%;" />
					<label id="licenseRes" class="reg-label">&nbsp;</label>
				</div>
				<div class="f-horizontal-line"></div>
				<div class="clearfix">
					<label class="reg-label">生日日期</label>
					<input id="birthday" class="reg-input" type="text" placeholder="输入驾驶证后生成" readonly="readonly" data-options='{"type":"date"}' />
				</div>
				<div class="f-horizontal-line"></div>
				<!--<div class="clearfix">
					<label class="reg-label">身份证号码</label>
					<input id="idCardNo" class="reg-input" type="text" placeholder="请输入身份证号码" />
				</div>
				<div class="f-horizontal-line"></div>-->
				<!--<div class="clearfix">
					<label class="reg-label">行驶证号码</label>
					<input id="xszNo" class="reg-input" type="text" placeholder="请输入行驶证号码" />
				</div>
				<div class="f-horizontal-line"></div>-->
				<div class="clearfix">
					<label class="reg-label">车牌号码</label>
					<div class="reg-val">
						<span id="prefix" class="reg-car-prefix">粤</span>
						<input id="carNo" class="reg-input" type="text" placeholder="请输入车牌号码" style="padding-left: 5px;" />
					</div>
				</div>
				<div class="f-horizontal-line"></div>
				<div class="clearfix">
					<label class="reg-label">车辆类型</label>
					<span id="carType" class="reg-val">小型车</span>
				</div>
			</div>

			<div class="m-reg-btn">
				<button type="button" class="mui-btn mui-btn-block" data-loading-text="提交中">提交信息</button>
			</div>
			<div id="popover" class="mui-popover" style="padding: 10px;">
				<div class="mui-popover-arrow"></div>
				<div id="tcDesc"></div>
			</div>
		</div>
		<script src="content/js/mui.min.js"></script>
		<script type="text/javascript" src="content/js/jquery-3.1.1.min.js"></script>
		<script type="text/javascript" src="content/js/mui.picker.min.js"></script>
		<script type="text/javascript" charset="utf-8">
			var islicensePass = 0;
			var arr = [{
				value: '冀',
				text: '冀'
			}, {
				value: '豫',
				text: '豫'
			}, {
				value: '云',
				text: '云'
			}, {
				value: '辽',
				text: '辽'
			}, {
				value: '黑',
				text: '黑'
			}, {
				value: '湘',
				text: '湘'
			}, {
				value: '皖',
				text: '皖'
			}, {
				value: '鲁',
				text: '鲁'
			}, {
				value: '新',
				text: '新'
			}, {
				value: '苏',
				text: '苏'
			}, {
				value: '浙',
				text: '浙'
			}, {
				value: '赣',
				text: '赣'
			}, {
				value: '鄂',
				text: '鄂'
			}, {
				value: '桂',
				text: '桂'
			}, {
				value: '甘',
				text: '甘'
			}, {
				value: '晋',
				text: '晋'
			}, {
				value: '蒙',
				text: '蒙'
			}, {
				value: '陕',
				text: '陕'
			}, {
				value: '吉',
				text: '吉'
			}, {
				value: '闽',
				text: '闽'
			}, {
				value: '贵',
				text: '贵'
			}, {
				value: '粤',
				text: '粤'
			}, {
				value: '川',
				text: '川'
			}, {
				value: '青',
				text: '青'
			}, {
				value: '藏',
				text: '藏'
			}, {
				value: '宁',
				text: '宁'
			}, {
				value: '渝',
				text: '渝'
			}, {
				value: '京',
				text: '京'
			}, {
				value: '津',
				text: '津'
			}, {
				value: '沪',
				text: '沪'
			}, {
				value: '琼',
				text: '琼'
			}];
			//调用微信JS api 支付
			function jsApiCall(reqJson) {
				WeixinJSBridge.invoke(
					'getBrandWCPayRequest', reqJson, //json串
					function(res) {
						mui(".m-reg-btn button").button("reset");
						WeixinJSBridge.log(res.err_msg);
						if(res.err_msg == "get_brand_wcpay_request:ok") {
							mui.openWindow({
								url: 'result.html',
							});
						} else if(res.err_msg == "get_brand_wcpay_request:cancel") {
							mui.toast("取消支付！");
						} else if(res.err_msg == "get_brand_wcpay_request:fail") {
							mui.toast("支付失败！" + res.err_desc);
						}
					}
				);
			}

			function callpay(reqJson) {
				if(typeof WeixinJSBridge == "undefined") {
					if(document.addEventListener) {
						document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
					} else if(document.attachEvent) {
						document.attachEvent('WeixinJSBridgeReady', jsApiCall);
						document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
					}
				} else {
					jsApiCall(reqJson);
				}
			}
			/**
			 * 提交订单
			 * @param {Object} licenseNo
			 * @param {Object} carNo
			 * @param {Object} carType
			 * @param {Object} tc
			 * @param {Object} fee
			 */
			function submitData(username, telephone, birthday, xszNo, licenseNo, carNo, carType, tc, fee) {
				var url = "http://alimeizi.top/blockchain/pay.php";
				$.ajax(url, {
					dataType: 'json', //服务器返回json格式数据
					type: 'POST', //HTTP请求类型
					data: {
						username: username,
						telephone: telephone,
						birthday: birthday,
						xszNo: xszNo,
						licenseNo: licenseNo,
						carNo: carNo,
						carType: carType,
						tc: tc,
						fee: fee,
					},
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						if(data.status == 200 && data.json != null && data.json != "") {
							console.log(data);
							mui(".m-reg-btn button").button('reset');
							jsApiCall(JSON.parse(data.json));
						} else {
							mui.toast('生成订单错误！');
							mui(".m-reg-btn button").button('reset');
						}

					},
					error: function(xhr, type, errorThrown) {
						//异常处理；
						console.log(type);
						mui.toast('提交失败！');
						mui(".m-reg-btn button").button('reset');
					}
				});
			}
			/**
			 * 检查输入
			 * @param {Object} username
			 * @param {Object} telephone
			 * @param {Object} birthday
			 * @param {Object} idCardNo
			 * @param {Object} xszNo
			 * @param {Object} licenseNo
			 * @param {Object} carNo
			 */
			function checkData(username, telephone, birthday, xszNo, licenseNo, carNo) {
				//手机号正则表达式
				var reg = /^1(3|4|5|7|8)\d{9}$/;
				// 身份证号码为15位或者18位，15位时全为数字，18位前17位为数字，最后一位是校验位，可能为数字或字符X  
				var reg2 = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
				//车牌号正则
				var reg3 = /^[A-Z]{1}[A-Z0-9]{4}[A-Z0-9挂学警港澳]{1}$/;
				if(username == null || username == "") {
					mui.toast("请输入会员名称！");
					return false;
				}
				if(username.length < 3) {
					mui.toast("会员名称不能太短");
					return false;
				}
				if(telephone == null || telephone == "") {
					mui.toast("请输入手机号码！");
					return false;
				}
				if(!reg.test(telephone)) {
					mui.toast('请输入正确手机号码');
					return false;
				}
				if(birthday == null || birthday == "") {
					mui.toast("请输入生日日期！");
					return false;
				}
				//				if(idCardNo == null || idCardNo == "") {
				//					mui.toast("请输入身份证号码！");
				//					return false;
				//				}
				//				if(!reg2.test(idCardNo)) {
				//					mui.toast('请输入正确身份证号');
				//					return false;
				//				}
				if(!islicensePass) {
					mui.toast('驾驶证未验证');
					return false;
				}
				if(xszNo == null || xszNo == "") {
					mui.toast("请输入行驶证号码！");
					return false;
				}
				if(licenseNo == null || licenseNo == "") {
					mui.toast("请输入驾驶证号码！");
					return false;
				}
				if(!reg2.test(licenseNo)) {
					mui.toast('请输入正确驾驶证号码');
					return false;
				}
				if(carNo == null || carNo == "") {
					mui.toast("请输入车牌号码！");
					return false;
				}
				if(!reg3.test(carNo)) {
					mui.toast("请输入正确车牌号码！");
					return false;
				}
				return true;
			}
			$(document).ready(function() {
				mui.init();
				$("#prefix").click(function(e) {
					//普通示例
					var province = new mui.PopPicker();
					province.setData(arr);
					province.show(function(item) {
						$("#prefix").text(item[0].value);
					});
				});
				$(".m-reg-btn button").click(function(e) {
					var username = $("#username").val();
					var telephone = $("#telephone").val();
					var birthday = $("#birthday").val();
					//					var idCardNo = $("#idCardNo").val();
					var xszNo = $("#xszNo").val();
					var licenseNo = $("#licenseNo").val();
					var carNo = $("#carNo").val();
					var prefix = $("#prefix").text();
					var tc = $("input[name='tc']:checked").val();
					var fee = $("input[name='tc']:checked").attr("fee");
					var vip = $("input[name='tc']:checked").attr("vip");
					var carType = $("#carType").text();

					if(checkData(username, telephone, birthday, xszNo, licenseNo, carNo)) {
						//输出正确拼接车牌
						carNo = prefix + carNo;
						console.log(carNo);
					} else {
						return;
					}

					var msg = "会员名称: " + username + "\n手机号码: " + telephone + "\n生日日期: " +
						birthday + "\n行驶证号码: " + xszNo + "\n驾驶证号码: " +
						licenseNo + "\n车牌号码: " + carNo + "\n车辆类型: " + carType + "\n选择套餐: " +
						vip + "\n价格: " + fee + "元";

					var btnArray = ['取消', '提交'];
					mui.confirm(msg, '确认信息', btnArray, function(e) {
						if(e.index == 1) {
							mui(".m-reg-btn button").button('loading'); //切换为loading状态
							submitData(username, telephone, birthday, xszNo, licenseNo, carNo, carType, tc, fee);
						} else {
							console.log("取消");
						}
					})
				});
				$("#birthday").click(function(e) {
					//					var picker = new mui.DtPicker({
					//						type: "date", //设置日历初始视图模式 
					//						beginDate: new Date(1950, 0, 01), //设置开始日期 
					//						endDate: new Date(), //设置结束日期 
					//					});
					//					picker.setSelectedValue("1970-01-01");
					//					picker.show(function(rs) {
					//						$("#birthday").val(rs.text);
					//						picker.dispose();
					//					});
				});
				/**
				 * 失去焦点校验
				 */
				$("#licenseNo").blur(function(e) {
					// 身份证号码为15位或者18位，15位时全为数字，18位前17位为数字，最后一位是校验位，可能为数字或字符X  
					var reg2 = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
					var licenseNo = $(this).val();

					if(licenseNo.length == 18) {
						var year = licenseNo.substring(6, 10);
						var month = licenseNo.substring(10, 12);
						var day = licenseNo.substring(12, 14);
						$("#birthday").val(year + "-" + month + "-" + day);
					} else if(licenseNo.length == 15) {
						var year = "19" + licenseNo.substring(6, 8);
						var month = licenseNo.substring(8, 10);
						var day = licenseNo.substring(10, 12);
						$("#birthday").val(year + "-" + month + "-" + day);
					} else {
						$("#birthday").val("");
					}

					if(licenseNo == null || licenseNo == "" || !reg2.test(licenseNo)) {
						$("#licenseRes").removeClass("test-success");
						$("#licenseRes").addClass("test-fail");
						$("#licenseRes").text("验证失败");
						islicensePass = 0;
						return false;
					}
					var url = "http://alimeizi.top/renbao/login.php";
					$.ajax(url, {
						dataType: 'json', //服务器返回json格式数据
						type: 'POST', //HTTP请求类型
						data: {
							licenseNo: licenseNo
						},
						timeout: 10000, //超时时间设置为10秒；
						success: function(data) {
							if(data.status == 200) {
								$("#licenseRes").removeClass("test-fail");
								$("#licenseRes").addClass("test-success");
								$("#licenseRes").text("验证通过");
								islicensePass = 1;
							} else {
								$("#licenseRes").removeClass("test-success");
								$("#licenseRes").addClass("test-fail");
								$("#licenseRes").text("驾驶证重复");
								islicensePass = 0;
							}
						},
						error: function(xhr, type, errorThrown) {
							//异常处理；
							console.log(type);
							islicensePass = 0;
						}
					});
				});
				mui(".radio-label").on("tap", "a", function(e) {
					var desc = $(this).attr("tc-desc");
					$("#tcDesc").html(desc);
				});
			});
		</script>
	</body>

</html>